import csv
import os
import locale
from time import sleep
from colors import bcolors  
import curses

def test_input(main_window):
    
    curses.curs_set(2)
    main_window.clear()
    main_window.addstr(0, 0, "Type something: ")
    main_window.clrtoeol()  # Clear line for input
    main_window.refresh()    # Refresh to show the updated window

    # Enable echoing of characters typed by the user
    curses.echo()

    # Get user input
    input_text = main_window.getstr(0, 16).decode("utf-8")  

    # Disable echoing again
    curses.noecho()

    # Display the input
    main_window.addstr(2, 0, f"You typed: {input_text}")  
    main_window.refresh()
    main_window.addstr(4, 0, "Press any key to exit.")
    main_window.refresh()
    main_window.getch()  # Wait for user to acknowledge

def main(stdscr):
    curses.curs_set(1)  # Show the cursor for input
    test_input(stdscr)

if __name__ == "__main__":
    curses.wrapper(main)

games = []

def Save_data(games, filepath):
    try:  #Sparar data till csv fil
        with open(filepath, 'w', newline='') as file:
            fieldnames = ['id', 'name', 'genre', 'rating', 'price', 'short_review', 'long_review']
            writer = csv.DictWriter(file, fieldnames=fieldnames)
            writer.writeheader()
            writer.writerows(games)

    except Exception as error_code:
        print("Fel", error_code)
    return f"OK"

def format_currency(value):
    return locale.currency(value,grouping=True)



    
locale.setlocale(locale.LC_ALL, 'sv_SE.UTF-8')  

def truncate_string(word, length=20):
    if len(word) > length:
        return word[:] + "..."    
    else:
        return word

def list_games(games):
    print(
        f"{bcolors.CYAN}=== Nintendo Games ==={bcolors.DEFAULT}")
    header = f"{bcolors.YELLOW}{'#':<4} {'NAMN':<30} {'GENRE':<26} {'RATING':<8} {'PRIS':<12} {'BESKRIVNING':<30}{bcolors.DEFAULT}"
    # rader för varje produkt:
    separator = "-" * 110           #linje
   
    #rader för varje produkt:
    rows = []
    

    for index, game in enumerate(games, 1):
        name = game['name']
        genre = game['genre']
        rating = game['rating']
        price = game['price']
        short_review = truncate_string(game['short_review'])
        long_review = game['long_review']
        
        price = locale.currency(price, grouping=True)
        row = f"{index:<4} {name:<30} {genre:<26} {rating:<8} {price:<12} {short_review:<30}"

        rows.append(row)
    
    # kombinera sidhuvud och rader:
    inventory_table = "\n".join([header, separator] + rows)
    
    print(inventory_table)
    
    
    return f"{inventory_table}"

def load_data(filename): 
    with open(filename, 'r') as file:       #öppnar en fil med read-rättighet
        reader = csv.DictReader(file)
        for row in reader:
            id = int(row['id'])
            name = row['name']
            genre = row['genre']
            price = float(row['price'])
            rating = row['rating']
            short_review = row['short_review']
            long_review = row['long_review']
           
            
            games.append(
                {                   
                    "id": id,       
                    "name": name,
                    "genre": genre,
                    "price": price,
                    "rating": rating,
                    "short_review": short_review,
                    "long_review": long_review,
                    
                }
            )

  
def show_detailed_review(game_id, games):
    os.system('cls')
    for game in games:
        if game["id"] == game_id:
            print(f"=== {game['name']} ===\n")
            print(game['genre'])
            print(game['price'],"kr") 
            print(game['long_review'])
            input("\nEnter to continue..")
            return
    print("No such game with that ID found.")
    input("\nEnter to continue..")
 
    
def game_details():
    os.system('cls')    
    if __name__ == "__main__":
        list_games(games)               # visar kort info för alla spel
        idx = int(input("Ange spel ID för att se lång recension: "))
        print("\n--- Lång recension för spel ID", {idx}, "---\n")
        show_detailed_review(idx, games)# visar bara lång recension för specifikt spel
        wait = input("\nEnter to continue..")

def remove_game(games):
    while True:
        list_games(games)
        print("-" * 110)   
        try:
            game_id = int(input("Ange spel ID för att ta bort: "))
        except ValueError:
            os.system('cls')
            print("Ogiltigt ID. Försök igen.")
            continue
            
        for game in games:
            if game["id"] == game_id:
                games.remove(game)
                print("Tar bort spel...")
                Save_data(games, 'db_games.csv')
                sleep(1)     
                return
        print("Inget spel med det ID:t hittades.")


def edit_game(games):
    list_games(games)
    print("-" * 110)   
    while True:
        try:
            game_id = int(input("Ange spel ID för att redigera: "))
        except ValueError:
            os.system('cls')
            print("Ogiltigt ID. Försök igen.")
            continue
        for game in games:
                if game["id"] == game_id:
                    print(f"Redigera {game['name']}:")
                    game['name'] = input(f"Namn ({game['name']}): ") or game['name']
                    game['genre'] = input(f"Genre ({game['genre']}): ") or game['genre']
                    try:
                        game['rating'] = float(input(f"Rating ({game['rating']}): ") or game['rating'])
                    except ValueError:
                        print("Ogiltig rating. Behåller tidigare värde.")
                    game['price'] = int(input(f"Pris ({game['price']}): ") or game['price'])
                    game['short_review'] = truncate_string(input(f"Kort recension ({game['short_review']}): ") or game['short_review'])
                    game['long_review'] = input(f"Lång recension ({game['long_review']}): ") or game['long_review']
                    Save_data(games, 'db_games.csv')
                    print("Sparar ändringar...")
                    sleep(1)
                    break
                else:
                    print("Inget spel med det ID:t hittades.")
                sleep(1)    

def add_game(games):
    os.system('cls')    
    print(f"""Vilket spel vill du lägga till?""")
    name = input("Namn: ")
    genre = input("Genre: ") 
    while True:      
        rating = input("Rating: (0.0 - 10.0): (T.ex 7.5) ")
        try:
            rating = float(rating)
        except ValueError:
            os.system('cls')
            print("Ogiltig rating. Ange ett nummer mellan 0.0 och 10.0.")
            
            continue
        if 0.0 <= rating <= 10.0:
            break
        os.system('cls')
        print("Rating måste vara mellan 0.0 och 10.0. Försök igen.")
        
    while True:      
        price = input("Pris: (Exempel: 599) ")
        try:
            price = int(price)
        except ValueError:
            os.system('cls')
            print("Ogiltig rating. Ange ett pris")
            
            continue
        if 0 <= rating <= 1000:
            break
        os.system('cls')
        print("Du skrev ett negativt pris eller för högt. Försök igen.")
    short_review = truncate_string(input("Kort recension: "))
    long_review = input("Längre recension: ")
    games.append({
        "id": len(games) + 1,
        "name": name,
        "genre": genre,
        "rating": rating,
        "short_review": short_review,
        "long_review": long_review,
        "price": price
    })
    Save_data(games, 'db_games.csv')
    print("Sparar produkt...")
    os.system('cls')    
    
load_data('db_games.csv')
menu_options = [
    "View detailed review",
    "Remove game",
    "Add game",
    "Edit game",
    "Finish"
]

while True:
    os.system('cls')
    list_games(games)
    print("-" * 110)   
    for index, choice in enumerate(menu_options, start=1):
        print(f"{index}. {choice}") 
    try:  
        print("\nChoose an alternative (1-5): ", end="")
        input_choice = int(input())
    except ValueError:
        continue
    os.system('cls')
    if input_choice == 1:
        try: 
            idx = int(input("Ange spel ID för att se lång recension: "))
            show_detailed_review(idx, games)
        except ValueError:
            print("Non-numeric value entered.")
            input("\nPress enter to continue...")
            
        
    elif input_choice == 2:
        remove_game(games)
    elif input_choice == 3:
        add_game(games)   
    elif input_choice == 4:
        edit_game(games)
    elif input_choice > 5 or input_choice < 1:
        os.system('cls')
    else:    
        print("Avslutar programmet...")
        sleep(0.5)
        break
    
    
